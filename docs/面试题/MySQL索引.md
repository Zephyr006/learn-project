

# MySQL组合索引

>  假设表 t 工包含4列，分别为A、B、C、D，其中A是主键，B、C 构成组合索引
>
> ```alter table tt add index idx_composition (`B`, `C`);```

- 组合索引是否生效与组合索引中列在where子句中出现的顺序无关，与出现了哪些列有关。如：

# MySQL聚簇索引

以下内容来自 [MySQL聚簇索引官方文档](https://www.mysqltutorial.org/mysql-index/mysql-clustered-index/)

### 聚簇索引的概念

通常，索引是一个独立的数据结构，例如B-Tree，索引的存储是用于更快查找的键值。另一方面，*聚集索引实际上是表， 它实际上是一种强制对表的行进行排序的索引*。一般来说，DBMS都会以聚簇索引的形式来存储实际的数据，它是其它二级索引的基础。

聚簇索引创建完成后，表中的所有行都将根据创建聚簇索引的关键列进行存储（注：也就是说，表中的所有数据都是按照索引列进行有序存储的）。因为聚集索引按排序顺序存储行，所以**每个表只有一个聚集索引**。

### InnoDB表上的MySQL聚集索引

每个InnoDB的表都要求有一个聚簇索引，聚簇索引帮助InnoDB表优化增删改查的数据操作。聚簇索引的创建逻辑如下：

- 当您为InnoDB表定义主键时，MySQL使用主键作为聚簇索引。

- 如果您没有表的主键，则MySQL将搜索第一个UNIQUE索引，其中所有键列都不为NULL，并将该UNIQUE索引用作聚集索引。

- 如果InnoDB表没有主键或合适的唯一索引（注：合适的唯一索引，指构成该唯一索引的所有列都不为NULL），则MySQL会（在包含行ID值的合成列上）生成一个名为GEN_CLUST_INDEX的隐藏的聚集索引。

**每个InnoDB表始终有且只有一个聚集索引**。

除聚簇索引外，所有其他索引均为非聚簇索引或辅助索引。 在InnoDB的表中，**辅助索引中的每个记录均包含该行的主键列以及非聚集索引中指定的列**。 MySQL将这个主键值用于聚集索引中的行查找。因此，主键应该尽量短一点，否则辅助索引将使用更多的空间。 通常，主键列推荐使用自增整数。

# 名词解释

### 回表

回表是什么意思？就是你执行一条sql语句，需要从两个b+索引中去取数据。举个例子，表table有a,b,c三个字段，其中id是主键，name上建了索引：

- `SELECT * FROM tbl WHERE id=1`这样不会产生回表，因为所有的数据在id的索引树中均能找到。
- `SELECT * FROM tbl WHERE name=1`这样就会产生回表，因为where条件是name字段，那么会去name的索引树里查找数据，但name的索引里面只有主键id和辅助索引name两个字段的值，没有c，那么这个查询为了取到c字段，就要取出主键id的值，然后去id的索引树去找c字段的数据，查了两个索引树，这就叫回表。

怎么避免？不是必须的字段就不要出现在SELECT里面。或者name,c建联合索引，或者使用主键进行select操作。但具体情况要具体分析，索引字段多了，存储和插入数据时的消耗会更大。这是个平衡问题。

![img](https://img-blog.csdnimg.cn/20190710211159462.png)

### 索引覆盖

索引覆盖就是查当前索引能查到所需要的所有数据，而不需要去另外的数据结构（通常是主键索引）去查。其实就是不用回表。

### 最左匹配原则

在组合索引中，MySQL会从索引中最左边出现的列开始匹配，并一直向右匹配直到遇到范围查询(>、<、between、like)就停止匹配，**where子句中的索引可以是任意顺序**，mysql的查询优化器会帮你优化成索引可以识别的形式。
> 帮助理解：当b+树的数据项是复合的数据结构，比如(name,age,sex)的时候，b+数是按照从左到右的顺序来建立搜索树的，比如当(张三,20,F)这样的数据来检索的时候，b+树会优先比较name来确定下一步的所搜方向，如果name相同再依次比较age和sex，最后得到检索的数据；但当(20,F)这样的没有name的数据来的时候，b+树就不知道下一步该查哪个节点，因为建立搜索树的时候name就是第一个比较因子，必须要先根据name来搜索才能知道下一步去哪里查询。比如当(张三,F)这样的数据来检索时，b+树可以用name来指定搜索方向，但下一个字段age的缺失，所以只能把名字等于张三的数据都找到，然后再匹配性别是F的数据了， 这个是非常重要的性质，即索引的最左匹配特性。